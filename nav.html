<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Workshop | Professional Event Planning Suite</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@300;400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #e4e4dc;
            --card: rgba(255, 255, 255, 0.5);
            --card-hover: rgba(255, 255, 255, 0.9);
            --text: #3d3d3d;
            --text-light: #666;
            --accent: #8b7355;
            --accent-light: rgba(139, 115, 85, 0.1);
            --border: rgba(61, 61, 61, 0.1);
            --border-strong: rgba(61, 61, 61, 0.2);
            --success: #5a7c5a;
            --danger: #b95d5d;
            --warning: #cc9933;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 60px 20px;
            color: var(--text);
            line-height: 1.6;
        }

        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #e4e4dc;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.8s ease-in-out;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            max-width: 400px;
            width: 80%;
            height: auto;
            opacity: 0;
            transform: scale(0.95);
            animation: logoFadeIn 1s ease-out forwards;
        }

        @keyframes logoFadeIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Main Content */
        #main-content {
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }

        #main-content.visible {
            opacity: 1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            padding-bottom: 40px;
            border-bottom: 1px solid rgba(61, 61, 61, 0.15);
        }

        .brand {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3em;
            font-weight: 500;
            color: #3d3d3d;
            margin-bottom: 8px;
            letter-spacing: 0.02em;
        }

        .tagline {
            font-size: 0.95em;
            color: #666;
            font-weight: 300;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .suite-overview {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(61, 61, 61, 0.1);
            border-radius: 8px;
            padding: 40px;
            margin-bottom: 50px;
        }

        .suite-overview h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1em;
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #3d3d3d;
            margin-bottom: 25px;
            text-align: center;
        }

        .tech-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tech-feature {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 6px;
            border-left: 2px solid #8b7355;
            transition: all 0.3s ease;
        }

        .tech-feature:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateX(3px);
        }

        .tech-icon {
            font-size: 1.2em;
            flex-shrink: 0;
            margin-top: 2px;
            opacity: 0.7;
        }

        .tech-text {
            font-size: 0.85em;
            color: #555;
            line-height: 1.5;
        }

        .tech-text strong {
            color: #3d3d3d;
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .suite-description {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.15em;
            color: #555;
            line-height: 1.7;
            font-style: italic;
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            border: 1px solid rgba(61, 61, 61, 0.08);
        }

        .tools-section h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #3d3d3d;
            margin-bottom: 30px;
            text-align: center;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
            margin-bottom: 60px;
        }

        .tool-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(61, 61, 61, 0.1);
            border-radius: 6px;
            padding: 22px 20px;
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .tool-card:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(139, 115, 85, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(61, 61, 61, 0.08);
        }

        .tool-card:hover .external-indicator {
            opacity: 1;
        }

        .tool-icon {
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid rgba(61, 61, 61, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .tool-card:hover .tool-icon {
            background: #3d3d3d;
            border-color: #3d3d3d;
        }

        .tool-info {
            flex-grow: 1;
        }

        .tool-name {
            font-weight: 500;
            font-size: 0.95em;
            margin-bottom: 2px;
            color: #3d3d3d;
            letter-spacing: 0.02em;
        }

        .tool-desc {
            font-size: 0.8em;
            color: #777;
            font-weight: 300;
        }

        .external-indicator {
            color: #8b7355;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        /* HUD MERGED STYLES */
        /* Upload Section */
        .upload-section {
            margin-bottom: 3rem;
        }

        .upload-section .card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(61, 61, 61, 0.1);
            border-radius: 6px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        #fileInput {
            display: none;
        }

        /* Data Display Grid */
        .loaded-data-section {
            margin-bottom: 3rem;
        }

        .loaded-data-section h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #3d3d3d;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .data-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(61, 61, 61, 0.1);
            border-radius: 6px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .data-card:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(139, 115, 85, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(61, 61, 61, 0.08);
        }

        .data-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-description {
            color: #666;
            font-size: 0.875rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            align-items: start;
            /* Fixes whitespace issue */
            margin-top: 1.5rem;
        }

        .data-card {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--border);
            overflow: hidden;
            /* For smooth expansion */
        }

        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--accent);
        }

        .data-preview {
            margin-top: 0;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.5);
            border-top: 1px solid rgba(139, 115, 85, 0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(61, 61, 61, 0.08);
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            color: #666;
            font-size: 0.875rem;
        }

        .data-value {
            font-weight: 600;
        }

        .import-timestamp {
            font-size: 0.75rem;
            color: #999;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(61, 61, 61, 0.15);
        }

        /* Buttons from HUD */
        button {
            background: #8b7355;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        button:hover {
            background: #6b5a45;
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(139, 115, 85, 0.3);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.25rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .toast.success {
            background-color: #8b7355;
        }

        .toast.error {
            background-color: #D32F2F;
        }

        .toast.info {
            background-color: #1976D2;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease;
        }

        .tool-card.loaded {
            border-color: rgba(139, 115, 85, 0.4);
            background: rgba(139, 115, 85, 0.08);
        }

        .badge {
            background: #8b7355;
            color: white;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 500;
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-left: auto;
        }

        .footer {
            text-align: center;
            padding-top: 40px;
            border-top: 1px solid rgba(61, 61, 61, 0.15);
            color: #888;
            font-size: 0.85em;
            font-weight: 300;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .version-badge {
            display: inline-block;
            background: rgba(139, 115, 85, 0.1);
            color: #8b7355;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 500;
            letter-spacing: 0.05em;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }

        .atelier-link {
            color: #8b7355;
            text-decoration: none;
            font-size: 0.85em;
            font-weight: 400;
            letter-spacing: 0.03em;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .atelier-link:hover {
            color: #6b5a45;
            transform: translateX(-3px);
        }

        .atelier-link::before {
            content: "‚Üê";
            font-size: 0.9em;
        }

        @media (max-width: 600px) {
            body {
                padding: 40px 16px;
            }

            .brand {
                font-size: 2.2em;
            }

            .tools-grid {
                grid-template-columns: 1fr;
            }

            .tech-features {
                grid-template-columns: 1fr;
            }

            .suite-overview {
                padding: 25px;
            }

            .splash-logo {
                max-width: 280px;
            }

            .tool-card {
                padding: 18px 16px;
            }
        }
    </style>
</head>

<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <img src="https://whisperworkshop.com/whisperworkshop.jpeg" alt="Whisper Workshop" class="splash-logo">
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <div class="container">
            <header>
                <h1 class="brand">Whisper Workshop</h1>
                <p class="tagline">Professional Event Planning Suite</p>
            </header>

            <div class="suite-overview">
                <!-- Upload Section (HUD) -->
                <div class="upload-section" style="margin-bottom: 2rem;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title" style="justify-content: center;">
                                <span class="emoji">üì•</span>
                                Import Tool Data
                            </h2>
                        </div>
                        <p class="card-description">Upload JSON files exported from Whisper Workshop tools to visualize
                            them below.</p>
                        <div
                            style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportFullEvent()" style="background:var(--accent); color:white;">
                                <span class="upload-icon">üíæ</span> Save Full Event
                            </button>
                            <button onclick="document.getElementById('fileInput').click()">
                                <span class="upload-icon">üì§</span> Load Event / Tool
                            </button>
                            <button onclick="scanLocalStorage()"
                                style="background: #e4e4dc; color: #3d3d3d; border: 1px solid rgba(61,61,61,0.2);">
                                <span class="upload-icon">üîÑ</span>Sync from Browser
                            </button>
                            <button onclick="clearStorage()"
                                style="background:var(--danger); color:white; border:none;">
                                <span class="upload-icon">üóëÔ∏è</span> Clear Storage
                            </button>
                        </div>
                        <input type="file" id="fileInput" accept=".json">
                    </div>
                </div>

                <!-- Loaded Data Section (HUD - Initially Hidden) -->
                <div id="loadedDataSection" class="loaded-data-section" style="display: none;">
                    <h2>Loaded Data</h2>
                    <div id="dataGrid" class="data-grid"></div>
                </div>

                <h2>Technical Foundation</h2>
                <div class="tech-features">
                    <div class="tech-feature">
                        <span class="tech-icon">üíæ</span>
                        <div class="tech-text">
                            <strong>Data Persistence</strong>
                            All tools use localStorage with versioned keys
                        </div>
                    </div>
                    <div class="tech-feature">
                        <span class="tech-icon">üîÑ</span>
                        <div class="tech-text">
                            <strong>Import/Export JSON</strong>
                            Backup and sharing capabilities
                        </div>
                    </div>
                    <div class="tech-feature">
                        <span class="tech-icon">üîó</span>
                        <div class="tech-text">
                            <strong>Cross-Tool Integration</strong>
                            Shared storage keys for seamless data flow
                        </div>
                    </div>
                    <div class="tech-feature">
                        <span class="tech-icon">üñ®Ô∏è</span>
                        <div class="tech-text">
                            <strong>Print-Optimized</strong>
                            Professional CSS for physical output
                        </div>
                    </div>
                </div>
                <p class="suite-description">
                    The complete 12-tool suite provides comprehensive event planning capabilities from initial guest
                    management through day-of coordination and post-event gratuity handling.
                </p>
            </div>

            <div class="tools-section">
                <h2>Suite Navigation</h2>
                <div class="tools-grid">
                    <a href="index.html" class="tool-card">
                        <div class="tool-icon">üè†</div>
                        <div class="tool-info">
                            <div class="tool-name">Atelier Home</div>
                            <div class="tool-desc">Return to welcome screen</div>
                        </div>
                    </a>
                </div>
            </div>

            <div class="tools-section">
                <h2>Event Planning Tools</h2>
                <div class="tools-grid">
                    <a href="bar-calculator.html" class="tool-card">
                        <div class="tool-icon">üç∏</div>
                        <div class="tool-info">
                            <div class="tool-name">Bar Calculator</div>
                            <div class="tool-desc">Beverage quantities & costs</div>
                        </div>
                    </a>

                    <a href="budget-calculator.html" class="tool-card">
                        <div class="tool-icon">üí∞</div>
                        <div class="tool-info">
                            <div class="tool-name">Budget Calculator</div>
                            <div class="tool-desc">Financial planning & tracking</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="floor-plan-designer.html" class="tool-card">
                        <div class="tool-icon">üìê</div>
                        <div class="tool-info">
                            <div class="tool-name">Floor Plan Designer</div>
                            <div class="tool-desc">Venue layout visualization</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="guest-list.html" class="tool-card">
                        <div class="tool-icon">üë•</div>
                        <div class="tool-info">
                            <div class="tool-name">Guest List</div>
                            <div class="tool-desc">Manage attendee details</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="gratuity-calculator.html" class="tool-card">
                        <div class="tool-icon">üíµ</div>
                        <div class="tool-info">
                            <div class="tool-name">Gratuity Calculator</div>
                            <div class="tool-desc">Tip distribution & totals</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="invitation-tracker.html" class="tool-card">
                        <div class="tool-icon">üíå</div>
                        <div class="tool-info">
                            <div class="tool-name">Invitation Tracker</div>
                            <div class="tool-desc">RSVP management</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="menu-planner.html" class="tool-card">
                        <div class="tool-icon">üçΩÔ∏è</div>
                        <div class="tool-info">
                            <div class="tool-name">Menu Planner</div>
                            <div class="tool-desc">Catering coordination</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="playlist-timer.html" class="tool-card">
                        <div class="tool-icon">üéµ</div>
                        <div class="tool-info">
                            <div class="tool-name">Playlist Timer</div>
                            <div class="tool-desc">Music scheduling</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="rain-plan-calculator.html" class="tool-card">
                        <div class="tool-icon">üåßÔ∏è</div>
                        <div class="tool-info">
                            <div class="tool-name">Rain Plan Calculator</div>
                            <div class="tool-desc">Weather contingency planning</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="seating-chart-builder.html" class="tool-card">
                        <div class="tool-icon">ü™ë</div>
                        <div class="tool-info">
                            <div class="tool-name">Seating Chart Builder</div>
                            <div class="tool-desc">Guest arrangement tool</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="timeline-scheduler.html" class="tool-card">
                        <div class="tool-icon">üìÖ</div>
                        <div class="tool-info">
                            <div class="tool-name">Timeline Scheduler</div>
                            <div class="tool-desc">Event day coordination</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>

                    <a href="vendor-comparison.html" class="tool-card">
                        <div class="tool-icon">üè™</div>
                        <div class="tool-info">
                            <div class="tool-name">Vendor Comparison</div>
                            <div class="tool-desc">Supplier evaluation</div>
                        </div>
                        <span class="external-indicator">‚Üó</span>
                    </a>
                </div>
            </div>

            <div class="footer">
                <!-- <a href="index.html" class="atelier-link">Return to Atelier</a> -->
                <span class="version-badge">v2.0 Enterprise Suite</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const splash = document.getElementById('splash-screen');
            const mainContent = document.getElementById('main-content');

            setTimeout(function () {
                splash.classList.add('fade-out');
                mainContent.classList.add('visible');

                setTimeout(function () {
                    splash.style.display = 'none';
                }, 800);
            }, 2000);

            // Initialize HUD features
            initializeToolsGrid();

            // Load custom order
            const storedOrder = localStorage.getItem('whisper_tools_order');
            if (storedOrder) {
                try {
                    toolsOrder = JSON.parse(storedOrder);
                } catch (e) { console.error('Failed to load tools order'); }
            }

            scanLocalStorage(); // Auto-scan on load
        });

        // --- HUD LOGIC ---

        const STORAGE_KEYS = {
            barCalculator: 'event_bar_v1',
            budgetCalculator: 'event_budget_v1',
            floorPlanDesigner: 'event_floorplan_v1',
            guestList: 'event_guests_v1',
            gratuityCalculator: 'event_gratuity_v1',
            invitationTracker: 'event_invitations_v1',
            menuPlanner: 'event_menu_v1',
            playlistTimer: 'event_playlist_v1',
            rainPlanCalculator: 'event_rainplan_v1',
            seatingChart: 'event_seating_v1',
            timelineScheduler: 'event_timeline_v1',
            vendorComparison: 'event_vendors_v1'
        };

        // State
        let toolsData = {};
        let expandedTools = new Set();
        let toolsOrder = []; // Track visual order of tools

        // Initialize tools grid badges
        function initializeToolsGrid() {
            // This function now just adds badges to existing links in the grid
            const toolCards = document.querySelectorAll('.tools-grid .tool-card');

            toolCards.forEach(card => {
                const href = card.getAttribute('href');
                if (!href || href === 'index.html') return;

                // Find key mapping based on href
                let key = null;
                for (const [k, v] of Object.entries(STORAGE_KEYS)) {
                    // Primitive check: if href contains the tool name roughly
                    // Actually, let's Map href to key explicitly or just check all keys
                    // Simpler: Reverse lookup the KEY from the href filename?
                    // mapping: bar-calculator.html -> barCalculator
                    const filename = href.replace('.html', '');
                    // Convert kebab-case to camelCase
                    const camelKey = filename.replace(/-./g, x => x[1].toUpperCase());

                    if (STORAGE_KEYS[camelKey]) {
                        key = camelKey;
                    }
                }

                // Fallback for seating-chart-builder -> seatingChart mapping
                if (href === 'seating-chart-builder.html') key = 'seatingChart';

                if (key && toolsData[key]) {
                    card.classList.add('loaded');
                    if (!card.querySelector('.badge')) {
                        card.insertAdjacentHTML('beforeend', '<div class="badge">‚úì</div>');
                    }
                } else {
                    card.classList.remove('loaded');
                    const badge = card.querySelector('.badge');
                    if (badge) badge.remove();
                }
            });
        }

        // Render data grid
        function renderDataGrid() {
            const dataGrid = document.getElementById('dataGrid');
            const loadedDataSection = document.getElementById('loadedDataSection');

            if (Object.keys(toolsData).length === 0) {
                loadedDataSection.style.display = 'none';
                initializeToolsGrid();
                return;
            }

            loadedDataSection.style.display = 'block';

            // Ensure toolsOrder contains all current keys in toolsData
            const currentKeys = new Set(Object.keys(toolsData));
            // First, filter out any keys from order that no longer exist
            toolsOrder = toolsOrder.filter(k => currentKeys.has(k));
            // Then append any new keys that aren't in order yet
            currentKeys.forEach(k => {
                if (!toolsOrder.includes(k)) {
                    toolsOrder.push(k);
                }
            });

            dataGrid.innerHTML = toolsOrder.map((key, index) => {
                const tool = toolsData[key];
                if (!tool) return ''; // Should not happen given filter above

                const preview = renderDataPreview(tool);

                return `
                    <div class="card data-card" 
                         draggable="true" 
                         data-key="${key}"
                         ondragstart="handleDragStart(event)" 
                         ondragover="handleDragOver(event)" 
                         ondrop="handleDrop(event)"
                         ondragend="handleDragEnd(event)">
                        <div class="card-header" onclick="toggleDataCard('${key}')">
                            <div style="flex: 1;">
                                <div class="card-title">
                                    <span class="emoji">${tool.emoji || 'üì¶'}</span>
                                    <span>${tool.name || key}</span>
                                </div>
                                <p class="card-description">${tool.description || 'Imported Data'}</p>
                            </div>
                             <div style="display:flex; gap:0.5rem; align-items:center;">
                                <button onclick="event.stopPropagation(); clearToolData('${key}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:#aaa;" title="Remove Data">üóëÔ∏è</button>
                            </div>
                        </div>
                        ${expandedTools.has(key) ? `
                            <div class="data-preview">
                                ${preview}
                                <div class="import-timestamp">
                                    Imported: ${new Date(tool.timestamp).toLocaleString()}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            initializeToolsGrid(); // Update badges
        }

        function toggleDataCard(key) {
            if (expandedTools.has(key)) {
                expandedTools.delete(key);
            } else {
                expandedTools.add(key);
            }
            renderDataGrid();
        }

        function clearToolData(key) {
            if (confirm(`Remove data for ${toolsData[key].name}?`)) {
                delete toolsData[key];
                // Also remove from order
                toolsOrder = toolsOrder.filter(k => k !== key);
                saveToolsOrder();

                showToast('Data removed', 'info');
                renderDataGrid();
            }
        }

        // --- Drag and Drop Handlers ---

        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = e.currentTarget; // The card element being dragged
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.currentTarget.getAttribute('data-key'));

            // Add slight delay so the drag image is created before we make the source translucent
            setTimeout(() => {
                e.currentTarget.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // Necessary. Allows us to drop.
            }
            e.dataTransfer.dropEffect = 'move';

            const card = e.target.closest('.data-card');
            if (card && card !== dragSrcEl) {
                card.classList.add('drag-over');
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation(); // Stops some browsers from redirecting.
            }

            // Don't do anything if dropping the same column we're dragging.
            const targetCard = e.target.closest('.data-card');
            if (dragSrcEl !== targetCard && targetCard) {
                const sourceKey = e.dataTransfer.getData('text/plain');
                const targetKey = targetCard.getAttribute('data-key');

                const sourceIndex = toolsOrder.indexOf(sourceKey);
                const targetIndex = toolsOrder.indexOf(targetKey);

                if (sourceIndex > -1 && targetIndex > -1) {
                    // Move item in array
                    toolsOrder.splice(sourceIndex, 1);
                    toolsOrder.splice(targetIndex, 0, sourceKey);

                    saveToolsOrder();
                    renderDataGrid();
                }
            }

            return false;
        }

        function handleDragEnd(e) {
            const cards = document.querySelectorAll('.data-card');
            cards.forEach(card => {
                card.classList.remove('dragging');
                card.classList.remove('drag-over');
            });
        }

        function saveToolsOrder() {
            localStorage.setItem('whisper_tools_order', JSON.stringify(toolsOrder));
        }

        // Render data preview
        function renderDataPreview(tool) {
            if (!tool.data) return '<div class="data-row">No data</div>';

            const { key, data } = tool;

            if (key === "barCalculator" && data.results) {
                return renderBarCalc(data);
            } else if (key === "budgetCalculator" && (data.summary || data.categories)) {
                return renderBudgetCalc(data);
            } else if ((key === "floorPlanDesigner") && data.objects) {
                return renderFloorPlanSVG(data);
            } else if (key === "seatingChart" && (data.tables || data.objects)) {
                if (data.tables) return renderSeatingChart(data);
                return renderFloorPlanSVG(data);
            } else if (key === "guestList" && (data.stats || Array.isArray(data))) {
                return renderGuestList(data);
            } else if (key === "gratuityCalculator" && data.totals) {
                return renderGratuityCalc(data);
            } else if (key === "invitationTracker" && data.stats) {
                return renderInvitationTracker(data);
            } else if (key === "menuPlanner" && data.courses) {
                return renderMenuPlanner(data);
            } else if (key === "playlistTimer" && data.info) {
                return renderPlaylistTimer(data);
            } else if (key === "rainPlanCalculator") {
                return renderRainPlan(data);
            } else if (key === "timelineScheduler" && (data.items || data.eventInfo)) {
                return renderTimeline(data);
            } else if (key === "vendorComparison" && data.quotes) {
                return renderVendorComp(data);
            }

            return `<pre style="font-size: 0.75rem; overflow: auto; max-height: 160px; background: #f0f0f0; padding: 0.75rem; border-radius: 0.25rem;">${JSON.stringify(data, null, 2)}</pre>`;
        }

        // --- VISUALIZATION HELPERS ---

        function renderBarCalc(data) {
            const total = data.results.totalDrinks || 1;
            const breakdown = Array.isArray(data.results.breakdown) ? data.results.breakdown : [];

            const getCount = (str) => {
                const item = breakdown.find(b => b.type.toLowerCase().includes(str));
                return item ? parseInt(item.servings) : 0;
            };

            const beer = getCount('beer');
            const wine = getCount('wine');
            const liquor = getCount('spirits');

            return `
                <div class="data-row">
                    <span class="data-label">Total Drinks</span>
                    <span class="data-value">${data.results.totalDrinks}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Est. Cost</span>
                    <span class="data-value">$${data.results.totalCost?.toFixed(2)}</span>
                </div>
                <div style="margin-top:0.5rem; display:flex; gap:4px; height:8px; border-radius:4px; overflow:hidden;">
                    <div style="width:${(beer / total) * 100}%; background:var(--warning);" title="Beer"></div>
                    <div style="width:${(wine / total) * 100}%; background:var(--danger);" title="Wine"></div>
                    <div style="width:${(liquor / total) * 100}%; background:var(--text);" title="Liquor"></div>
                </div>
            `;
        }

        function renderBudgetCalc(data) {
            const spent = data.summary?.totalSpent || 0;
            const total = data.summary?.totalBudget || 1;
            const pct = Math.min(100, (spent / total) * 100);
            const color = pct > 100 ? 'var(--danger)' : 'var(--success)';

            return `
                <div class="data-row">
                    <span class="data-label">Budget Status</span>
                    <span class="data-value">$${spent.toLocaleString()} / $${total.toLocaleString()}</span>
                </div>
                <div style="background:rgba(0,0,0,0.05); height:8px; border-radius:4px; margin-top:0.5rem; overflow:hidden;">
                    <div style="width:${pct}%; height:100%; background:${color};"></div>
                </div>
                <div style="margin-top:0.5rem; font-size:0.75rem; color:#666;">
                    ${Object.keys(data.categories || {}).length} categories tracked
                </div>
            `;
        }

        function renderGuestList(data) {
            let stats = data.stats;
            if (!stats && Array.isArray(data)) {
                // Calculate stats from array
                stats = {
                    total: data.length,
                    accepted: data.filter(g => g.rsvp === 'accepted').length,
                    declined: data.filter(g => g.rsvp === 'declined').length
                };
            }
            if (!stats) return '<div class="data-row">Invalid Guest Data</div>';

            return `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; text-align:center;">
                    <div style="background:#f9fafb; padding:0.5rem; border-radius:4px;">
                        <div style="font-weight:600; font-size:1.1rem;">${stats.total || 0}</div>
                        <div style="font-size:0.7rem; color:#666;">GUESTS</div>
                    </div>
                    <div style="background:var(--success); color:white; padding:0.5rem; border-radius:4px;">
                        <div style="font-weight:600; font-size:1.1rem;">${stats.accepted || 0}</div>
                        <div style="font-size:0.7rem; opacity:0.9;">CONFIRMED</div>
                    </div>
                </div>
                 <div class="data-row" style="margin-top:0.5rem;">
                    <span class="data-label">Pending RSVP</span>
                    <span class="data-value">${(stats.total || 0) - (stats.accepted || 0) - (stats.declined || 0)}</span>
                </div>
            `;
        }

        function renderGratuityCalc(data) {
            return `
                <div class="data-row">
                    <span class="data-label">Total to Tip</span>
                    <span class="data-value">$${data.totals.planned}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Already Paid</span>
                    <span class="data-value" style="color:var(--success);">$${data.totals.paid}</span>
                </div>
                <div class="data-row" style="border-top:1px dashed #ddd; padding-top:0.5rem; margin-top:0.25rem;">
                    <span class="data-label">Remaining</span>
                    <span class="data-value" style="color:var(--danger);">$${data.totals.remaining}</span>
                </div>
            `;
        }

        function renderInvitationTracker(data) {
            const { sent, opened, responded } = data.stats;
            const total = sent || 1;
            return `
                <div class="data-row">
                    <span class="data-label">Pipeline</span>
                    <span class="data-value">${Math.round(responded / total * 100)}% Response</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px; margin-top:0.5rem;">
                    <div style="flex:1; height:4px; background:var(--accent);" title="Sent"></div>
                    <div style="width:8px; height:8px; border-radius:50%; background:${opened > 0 ? 'var(--accent)' : '#ddd'};"></div>
                    <div style="flex:1; height:4px; background:${opened > 0 ? 'var(--accent)' : '#ddd'};"></div>
                    <div style="width:8px; height:8px; border-radius:50%; background:${responded > 0 ? 'var(--accent)' : '#ddd'};"></div>
                     <div style="flex:1; height:4px; background:${responded > 0 ? 'var(--accent)' : '#ddd'};"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#666; margin-top:0.25rem;">
                    <span>Sent (${sent})</span>
                    <span>Opened</span>
                    <span>Replied</span>
                </div>
            `;
        }

        function renderMenuPlanner(data) {
            const counts = data.dietary || {};
            const dietTags = Object.entries(counts)
                .map(([k, v]) => v > 0 ? `<span style="font-size:0.65rem; background:#eee; padding:2px 4px; border-radius:3px; margin-right:4px;">${k.substring(0, 3).toUpperCase()}:${v}</span>` : '')
                .join('');

            return `
                 <div class="data-row">
                    <span class="data-label">Service Style</span>
                    <span class="data-value">${data.eventInfo?.style || 'N/A'}</span>
                </div>
                <div style="margin-top:0.5rem;">
                    <strong style="font-size:0.75rem; color:#666;">MENU COURSES:</strong>
                     <div style="font-size:0.85rem;">${data.courses.map(c => c.name).join(' ‚Ä¢ ')}</div>
                </div>
                <div style="margin-top:0.5rem; display:flex; gap:4px; flex-wrap:wrap;">
                    ${dietTags}
                </div>
            `;
        }

        function renderPlaylistTimer(data) {
            const mins = Math.round((data.info.totalDuration || 0) / 60);
            return `
                 <div class="data-row">
                    <span class="data-label">Total Duration</span>
                    <span class="data-value">${Math.floor(mins / 60)}h ${mins % 60}m</span>
                </div>
                 <div class="data-row">
                    <span class="data-label">Song Count</span>
                    <span class="data-value">${data.info.songCount} tracks</span>
                </div>
                <div style="margin-top:0.5rem; font-size:0.75rem; color:#666;">
                    Top Moods: ${Object.keys(data.moods || {}).slice(0, 3).join(', ')}
                </div>
            `;
        }

        function renderRainPlan(data) {
            const prob = data.rainProbability !== undefined ? data.rainProbability : (data.probability || 0);
            const isHighRisk = prob > 40;
            return `
                <div style="display:flex; align-items:center; gap:1rem;">
                    <div style="font-size:2rem;">${prob > 50 ? 'üåßÔ∏è' : '‚òÄÔ∏è'}</div>
                    <div style="flex:1;">
                        <div class="data-row" style="margin-bottom:0;">
                            <span class="data-label">Rain Risk</span>
                            <span class="data-value">${prob}%</span>
                        </div>
                         <div style="font-size:0.75rem; color:${isHighRisk ? 'var(--danger)' : 'var(--success)'}; font-weight:600;">
                            ${isHighRisk ? 'PLAN B ADVISED' : 'PLAN A GO'}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTimeline(data) {
            const items = data.items || [];
            return `
                <div style="margin-bottom:0.5rem; font-size:0.8rem; font-weight:600; color:var(--accent);">
                    ${data.eventInfo?.date || 'Event Date'}
                </div>
                <div style="border-left:2px solid #ddd; padding-left:0.75rem; margin-left:0.25rem;">
                    ${items.slice(0, 3).map(item => `
                        <div style="margin-bottom:0.5rem; position:relative;">
                            <div style="position:absolute; left:-1.1rem; top:0.3rem; width:8px; height:8px; border-radius:50%; background:var(--accent);"></div>
                            <div style="font-size:0.75rem; font-weight:600;">${item.time}</div>
                            <div style="font-size:0.8rem;">${item.activity}</div>
                        </div>
                    `).join('')}
                    ${items.length > 3 ? `<div style="font-size:0.7rem; color:#666;">+ ${(items.length - 3)} more events</div>` : ''}
                </div>
            `;
        }

        function renderVendorComp(data) {
            const quotes = data.quotes || [];
            const top = quotes.sort((a, b) => (b.score || 0) - (a.score || 0))[0];
            return `
                 <div class="data-row">
                    <span class="data-label">Category</span>
                    <span class="data-value">${data.category || 'Vendor'}</span>
                </div>
                ${top ? `
                <div style="background:#fdf8f6; padding:0.75rem; border:1px solid #eee; border-radius:4px; margin-top:0.5rem;">
                    <div style="font-size:0.7rem; color:var(--accent); text-transform:uppercase; font-weight:600;">Top Pick</div>
                    <div style="font-weight:600; font-family:'Cormorant Garamond', serif; font-size:1.1rem;">${top.name}</div>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-top:0.25rem;">
                        <span>$${top.price}</span>
                        <span>‚≠ê ${top.rating} (${top.score}/100)</span>
                    </div>
                </div>
                ` : '<div style="font-size:0.8rem;">No quotes added</div>'}
            `;
        }

        function renderSeatingChart(data) {
            const tables = data.tables || [];
            const totalGuests = tables.reduce((acc, t) => acc + (t.guests ? t.guests.filter(g => g).length : 0), 0);

            // Simple preview: just text stats + a placeholder visualization
            return `
                  <div class="data-row">
                    <span class="data-label">Total Tables</span>
                    <span class="data-value">${tables.length}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Seated Guests</span>
                    <span class="data-value">${totalGuests}</span>
                </div>
                <!-- Mini visualization of table distribution -->
                <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:4px;">
                     ${tables.slice(0, 12).map(t => `<div style="width:12px; height:12px; background:var(--accent); border-radius:${t.type.includes('round') ? '50%' : '2px'}; opacity:0.7;" title="Table ${t.id}"></div>`).join('')}
                     ${tables.length > 12 ? '<span style="font-size:0.7rem; color:#888;">+more</span>' : ''}
                </div>
             `;
        }

        // Helper to render Floor Plan SVG
        function renderFloorPlanSVG(data) {
            if (!data.room || !data.objects) return '<div class="data-row">Invalid Floor Plan Data</div>';

            const { width, length } = data.room;
            const padding = 2;
            const viewBox = `${-padding} ${-padding} ${width + padding * 2} ${length + padding * 2}`;

            const objectsSVG = data.objects.map(obj => {
                if (obj.shape === 'rect' || obj.shape === 'wall') {
                    const color = obj.shape === 'wall' ? '#000' : (obj.color || '#8b7355');
                    const x = obj.x - (obj.width / 2);
                    const y = obj.y - (obj.length / 2);
                    return `<rect x="${x}" y="${y}" width="${obj.width}" height="${obj.length}" fill="${color}" stroke="rgba(0,0,0,0.1)" stroke-width="0.2" rx="0.5" />`;
                } else if (obj.shape === 'circle') {
                    const color = obj.color || '#8b7355';
                    const r = obj.width / 2;
                    return `<circle cx="${obj.x}" cy="${obj.y}" r="${r}" fill="${color}" stroke="rgba(0,0,0,0.1)" stroke-width="0.2" />`;
                }
                return '';
            }).join('');

            return `
                <div style="width: 100%; aspect-ratio: ${width}/${length}; background: #fff; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                    <svg viewBox="${viewBox}" style="width: 100%; height: 100%; display: block;">
                        <!-- Room Background -->
                        <rect x="0" y="0" width="${width}" height="${length}" fill="#f9f9f9" stroke="#ccc" stroke-width="0.2" />
                        <!-- Grid -->
                        <line x1="0" y1="0" x2="${width}" y2="${length}" stroke="#eee" stroke-width="0.1" />
                        <line x1="0" y1="${length}" x2="${width}" y2="0" stroke="#eee" stroke-width="0.1" />
                        ${objectsSVG}
                    </svg>
                </div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; text-align: center;">
                    Room: ${width}' x ${length}' | Objects: ${data.objects.length}
                </div>
            `;
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target?.result);
                    processImport(jsonData);
                } catch (error) {
                    console.error(error);
                    showToast("Invalid JSON file", 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        function processImport(jsonData) {
            // Handle Full Event explicitly first
            if (jsonData.type === "fullEvent" && jsonData.data) {
                const keysToImport = Object.keys(jsonData.data);
                const conflicts = keysToImport.filter(key =>
                    STORAGE_KEYS[key] && localStorage.getItem(STORAGE_KEYS[key])
                );

                if (conflicts.length > 0) {
                    const toolNames = conflicts.map(k => k.replace(/([A-Z])/g, ' $1').trim()); // Prettify
                    if (!confirm(`‚ö†Ô∏è Warning: This import will overwrite existing data for ${conflicts.length} tools:\n\n‚Ä¢ ${toolNames.join('\n‚Ä¢ ')}\n\nContinue and overwrite?`)) {
                        return;
                    }
                }

                Object.entries(jsonData.data).forEach(([key, value]) => {
                    if (STORAGE_KEYS[key]) {
                        localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(value));
                    }
                });
                scanLocalStorage(); // Refresh grid
                showToast("Full event imported successfully", 'success');
                return;
            }

            let detectedToolKey = null;
            let dataPayload = jsonData;

            if (jsonData.app === "WhisperWorkshop" && jsonData.type) {
                detectedToolKey = jsonData.type;
                dataPayload = jsonData.data;
            }
            // Heuristics
            else if (jsonData.inputs?.barType !== undefined) detectedToolKey = "barCalculator";
            else if (Array.isArray(jsonData) && jsonData.length > 0 && jsonData[0].rsvp) detectedToolKey = "guestList";
            else if (jsonData.items && jsonData.eventInfo) detectedToolKey = "timelineScheduler";
            else if (Array.isArray(jsonData) && jsonData.length > 0 && jsonData[0].quote) detectedToolKey = "vendorComparison";

            if (detectedToolKey && STORAGE_KEYS[detectedToolKey]) {
                const toolName = detectedToolKey.replace(/([A-Z])/g, ' $1').trim();

                // Map keys to Emoji/Desc manually since we don't have TOOL_CONFIGS array fully
                // Or we can rebuild it simply
                const META = {
                    barCalculator: { emoji: "üç∏", name: "Bar Calculator" },
                    budgetCalculator: { emoji: "üí∞", name: "Budget Calculator" },
                    floorPlanDesigner: { emoji: "üìê", name: "Floor Plan Designer" },
                    guestList: { emoji: "üë•", name: "Guest List" },
                    gratuityCalculator: { emoji: "üíµ", name: "Gratuity Calculator" },
                    invitationTracker: { emoji: "üíå", name: "Invitation Tracker" },
                    menuPlanner: { emoji: "üçΩÔ∏è", name: "Menu Planner" },
                    playlistTimer: { emoji: "üéµ", name: "Playlist Timer" },
                    rainPlanCalculator: { emoji: "üåßÔ∏è", name: "Rain Plan Calculator" },
                    seatingChart: { emoji: "ü™ë", name: "Seating Chart Builder" },
                    timelineScheduler: { emoji: "üìÖ", name: "Timeline Scheduler" },
                    vendorComparison: { emoji: "üè™", name: "Vendor Comparison" }
                };

                const meta = META[detectedToolKey] || { emoji: "üì¶", name: detectedToolKey };

                toolsData[detectedToolKey] = {
                    key: detectedToolKey,
                    name: meta.name,
                    emoji: meta.emoji,
                    description: "Imported from file",
                    timestamp: new Date().toISOString(),
                    data: dataPayload
                };

                // Save to localStorage so tool picks it up!
                try {
                    localStorage.setItem(STORAGE_KEYS[detectedToolKey], JSON.stringify(dataPayload));
                    showToast(`Imported ${meta.name} data`, 'success');
                } catch (e) {
                    showToast("Error saving to storage", 'error');
                }

                renderDataGrid();
            } else {
                showToast("Unknown file format", 'error');
            }
        }

        function scanLocalStorage() {
            let foundCount = 0;
            const META = {
                barCalculator: { emoji: "üç∏", name: "Bar Calculator" },
                budgetCalculator: { emoji: "üí∞", name: "Budget Calculator" },
                floorPlanDesigner: { emoji: "üìê", name: "Floor Plan Designer" },
                guestList: { emoji: "üë•", name: "Guest List" },
                gratuityCalculator: { emoji: "üíµ", name: "Gratuity Calculator" },
                invitationTracker: { emoji: "üíå", name: "Invitation Tracker" },
                menuPlanner: { emoji: "üçΩÔ∏è", name: "Menu Planner" },
                playlistTimer: { emoji: "üéµ", name: "Playlist Timer" },
                rainPlanCalculator: { emoji: "üåßÔ∏è", name: "Rain Plan Calculator" },
                seatingChart: { emoji: "ü™ë", name: "Seating Chart Builder" },
                timelineScheduler: { emoji: "üìÖ", name: "Timeline Scheduler" },
                vendorComparison: { emoji: "üè™", name: "Vendor Comparison" }
            };

            for (const [key, storageKey] of Object.entries(STORAGE_KEYS)) {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        const meta = META[key] || { emoji: "üì¶", name: key };

                        toolsData[key] = {
                            key: key,
                            name: meta.name,
                            emoji: meta.emoji,
                            description: "Synced from browser",
                            timestamp: new Date().toISOString(), // We don't know real timestamp unless stored
                            data: data
                        };
                        foundCount++;
                    } catch (e) {
                        console.error("Error parsing", key);
                    }
                }
            }
            renderDataGrid();
            if (foundCount > 0) {
                // Optional: showToast(`Synced ${foundCount} tools`, 'info');
            }
        }

        function exportFullEvent() {
            const bundle = {
                app: "WhisperWorkshop",
                type: "fullEvent",
                version: "1.0",
                timestamp: new Date().toISOString(),
                data: {}
            };

            let count = 0;
            for (const [key, storageKey] of Object.entries(STORAGE_KEYS)) {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    try {
                        bundle.data[key] = JSON.parse(stored);
                        count++;
                    } catch (e) {
                        console.error("Failed to bundle", key);
                    }
                }
            }

            if (count === 0) {
                showToast("No data to save", 'error');
                return;
            }

            const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `whisper_event_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast(`Saved ${count} tools to event file`, 'success');
        }

        function clearStorage() {
            if (confirm("Are you sure you want to clear all browser storage for these tools? This cannot be undone.")) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                toolsData = {};
                renderDataGrid();
                showToast("All tool data cleared from browser storage", "success");
            }
        }
    </script>
</body>

</html>