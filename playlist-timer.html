<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Playlist Timer - Whisper Workshop</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@300;400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #e4e4dc;
            --card: rgba(255, 255, 255, 0.5);
            --card-hover: rgba(255, 255, 255, 0.9);
            --text: #3d3d3d;
            --text-light: #666;
            --accent: #8b7355;
            --accent-light: rgba(139, 115, 85, 0.1);
            --border: rgba(61, 61, 61, 0.1);
            --border-strong: rgba(61, 61, 61, 0.2);
            --success: #5a7c5a;
            --danger: #b95d5d;
            --warning: #cc9933;
            --info: #5d7cb9;
            --purple: #7d5db9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            width: 100%;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.8s ease-in-out;
            pointer-events: auto;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        .splash-content {
            text-align: center;
            opacity: 0;
            transform: scale(0.95);
            animation: logoFadeIn 1s ease-out forwards;
        }

        .splash-logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3em;
            color: var(--text);
            margin-bottom: 10px;
        }

        .splash-tagline {
            font-size: 0.9em;
            color: var(--text-light);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        @keyframes logoFadeIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #main-content {
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            min-height: 100vh;
        }

        #main-content.visible {
            opacity: 1;
        }

        /* Nav */
        .nav-header {
            background: rgba(255, 255, 255, 0.4);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5em;
            font-weight: 500;
            color: var(--text);
            text-decoration: none;
        }

        .nav-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: #6b5a45;
            transform: translateX(-3px);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 2rem;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5em;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 10px;
        }

        header p {
            color: var(--text-light);
            font-size: 0.95em;
            letter-spacing: 0.05em;
        }

        .event-sync {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: var(--text);
            font-family: 'Cormorant Garamond', serif;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.5rem;
        }

        .playlist-builder {
            background: var(--card);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .builder-header {
            background: rgba(255, 255, 255, 0.5);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .builder-header h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5em;
            color: var(--accent);
            font-weight: 500;
        }

        .song-form {
            padding: 2rem;
            background: rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid var(--border);
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .song-list {
            padding: 2rem;
        }

        .song-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto auto;
            gap: 1.5rem;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            cursor: grab;
            transition: all 0.2s;
        }

        .song-item:hover {
            border-color: var(--accent);
            background: white;
            transform: translateX(3px);
        }

        .song-item.dragging {
            opacity: 0.5;
            border-style: dashed;
        }

        .drag-handle {
            color: var(--border-strong);
            cursor: grab;
            padding: 0.5rem;
            font-size: 1.2em;
        }

        .song-info {
            display: flex;
            flex-direction: column;
        }

        .song-title {
            font-weight: 500;
            color: var(--text);
            font-size: 1.05em;
        }

        .song-artist {
            font-size: 0.9em;
            color: var(--text-light);
            font-style: italic;
        }

        .song-genre {
            font-size: 0.75em;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .duration-badge {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-family: 'Inter', monospace;
            font-size: 0.9em;
            border: 1px solid var(--border);
        }

        .time-slot {
            background: rgba(139, 115, 85, 0.1);
            color: var(--accent);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-family: 'Inter', monospace;
            font-size: 0.85em;
            border: 1px solid var(--border);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border-strong);
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Inter', sans-serif;
            background: white;
            color: var(--text);
        }

        .btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-primary {
            background: var(--text);
            color: var(--bg);
            border-color: var(--text);
        }

        .btn-primary:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn-danger {
            background: rgba(185, 93, 93, 0.05);
            color: var(--danger);
            border-color: rgba(185, 93, 93, 0.2);
            padding: 0.5rem;
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        input,
        select {
            padding: 0.75rem;
            border: 1px solid var(--border-strong);
            border-radius: 4px;
            font-size: 0.95rem;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.6);
            width: 100%;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
        }

        .mood-presets {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .mood-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            color: var(--text-light);
        }

        .mood-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
        }

        .segment-divider {
            background: linear-gradient(90deg, var(--accent), #a89070);
            color: white;
            padding: 0.5rem 1.5rem;
            margin: 1.5rem -1.5rem;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1em;
            letter-spacing: 0.05em;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.9;
        }

        .data-controls {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--card);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .warning-box {
            background: rgba(204, 153, 51, 0.1);
            border-left: 3px solid var(--warning);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0 4px 4px 0;
            display: none;
        }

        .warning-box.active {
            display: block;
        }

        @media print {

            .nav-header,
            .builder-header button,
            .song-form,
            .btn,
            .data-controls,
            #splash-screen {
                display: none;
            }

            .container {
                padding: 0;
            }

            body {
                background: white;
            }

            .playlist-builder {
                border: 1px solid #ccc;
            }
        }
    </style>
</head>

<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-logo">Playlist Timer</div>
            <div class="splash-tagline">Professional Event Planning Suite</div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <nav class="nav-header">
            <div class="nav-container">
                <a href="https://whisperworkshop.com/nav.html" class="nav-brand">Playlist Timer</a>
                <a href="https://whisperworkshop.com/nav.html" class="nav-link">Return to Whisper Workshop Tool
                    Suite</a>
            </div>
        </nav>

        <div class="container">
            <header>
                <h1>Playlist Timer</h1>
                <p>Build event soundtracks with precise timing for seamless transitions</p>
            </header>

            <div class="event-sync">
                <strong style="color: var(--accent);">Sync with Timeline:</strong>
                <select id="timelineSelect" onchange="syncWithTimeline()" style="max-width: 300px;">
                    <option value="">-- Manual Mode --</option>
                </select>
                <span id="syncStatus" style="color: var(--text-light); font-size: 0.9em; margin-left: auto;"></span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSongs">0</div>
                    <div class="stat-label">Songs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDuration">00:00</div>
                    <div class="stat-label">Total Length</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgDuration">00:00</div>
                    <div class="stat-label">Avg. Song</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="endTime">--:--</div>
                    <div class="stat-label">Est. End Time</div>
                </div>
            </div>

            <div class="warning-box" id="overageWarning">
                <strong style="color: #997a00;">Timing Alert:</strong> Your playlist exceeds the available time slot by
                <span id="overageAmount" style="font-weight: 600;"></span>.
            </div>

            <div class="playlist-builder">
                <div class="builder-header">
                    <h3>Playlist Builder</h3>
                    <button class="btn" onclick="clearPlaylist()">Clear All</button>
                </div>

                <div class="song-form">
                    <div class="mood-presets">
                        <span style="font-size: 0.9em; color: var(--text-light); align-self: center;">Quick Add:</span>
                        <button class="mood-btn" onclick="addPreset('cocktail')">Cocktail Hour</button>
                        <button class="mood-btn" onclick="addPreset('dinner')">Dinner Jazz</button>
                        <button class="mood-btn" onclick="addPreset('dance')">Dance Party</button>
                        <button class="mood-btn" onclick="addPreset('slow')">Slow Songs</button>
                        <button class="mood-btn" onclick="addPreset('last')">Last Dance</button>
                    </div>

                    <div class="form-row">
                        <input type="text" id="songTitle" placeholder="Song Title">
                        <input type="text" id="songArtist" placeholder="Artist">
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="songDuration" style="flex: 1;">
                                <option value="180">3:00</option>
                                <option value="210">3:30</option>
                                <option value="240" selected>4:00</option>
                                <option value="270">4:30</option>
                                <option value="300">5:00</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input type="number" id="customDuration" placeholder="Sec"
                                style="display: none; width: 70px;">
                        </div>

                        <button class="btn btn-primary" onclick="addSong()">Add Song</button>
                    </div>
                    <select id="songGenre" style="margin-top: 1rem; max-width: 200px;">
                        <option value="Pop">Pop</option>
                        <option value="Rock">Rock</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Classical">Classical</option>
                        <option value="R&B">R&B</option>
                        <option value="Country">Country</option>
                        <option value="Electronic">Electronic</option>
                        <option value="Hip Hop">Hip Hop</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="song-list" id="songList"></div>
            </div>

            <div class="data-controls">
                <button class="btn btn-primary" onclick="exportPlaylist()">Export Playlist</button>
                <div style="position: relative; overflow: hidden; display: inline-block;">
                    <button class="btn" onclick="document.getElementById('importFile').click()">Import Playlist</button>
                    <input type="file" id="importFile" accept=".json" style="position: absolute; left: -9999px;"
                        onchange="importPlaylist(this)">
                </div>
                <button class="btn" onclick="window.print()">Print Playlist</button>
                <button class="btn" onclick="shareWithDJ()">Share with DJ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const splash = document.getElementById('splash-screen');
            const mainContent = document.getElementById('main-content');

            setTimeout(function () {
                splash.classList.add('fade-out');
                mainContent.classList.add('visible');

                setTimeout(function () {
                    splash.style.display = 'none';
                }, 800);
            }, 1500);

            init();
        });

        const STORAGE_KEY = 'event_playlist_v1';
        let songs = [];
        let eventStartTime = null;
        let eventDuration = null; // in minutes

        const PRESETS = {
            cocktail: [
                { title: "Feeling Good", artist: "Nina Simone", duration: 180, genre: "Jazz" },
                { title: "Put Your Records On", artist: "Corinne Bailey Rae", duration: 204, genre: "Pop" },
                { title: "The Way You Look Tonight", artist: "Frank Sinatra", duration: 195, genre: "Jazz" }
            ],
            dinner: [
                { title: "What a Wonderful World", artist: "Louis Armstrong", duration: 139, genre: "Jazz" },
                { title: "La Vie En Rose", artist: "Édith Piaf", duration: 184, genre: "Classical" },
                { title: "Can't Help Falling in Love", artist: "Elvis Presley", duration: 182, genre: "Pop" }
            ],
            dance: [
                { title: "Shut Up and Dance", artist: "WALK THE MOON", duration: 199, genre: "Pop" },
                { title: "Uptown Funk", artist: "Mark Ronson ft. Bruno Mars", duration: 270, genre: "Funk" },
                { title: "Dancing Queen", artist: "ABBA", duration: 230, genre: "Disco" }
            ],
            slow: [
                { title: "Perfect", artist: "Ed Sheeran", duration: 263, genre: "Pop" },
                { title: "All of Me", artist: "John Legend", duration: 269, genre: "R&B" },
                { title: "At Last", artist: "Etta James", duration: 182, genre: "R&B" }
            ],
            last: [
                { title: "Don't Stop Believin'", artist: "Journey", duration: 250, genre: "Rock" },
                { title: "Closing Time", artist: "Semisonic", duration: 208, genre: "Rock" },
                { title: "Time of My Life", artist: "Bill Medley & Jennifer Warnes", duration: 285, genre: "Pop" }
            ]
        };

        function init() {
            loadPlaylist();
            loadTimelines();

            document.getElementById('songDuration').addEventListener('change', (e) => {
                const customInput = document.getElementById('customDuration');
                if (e.target.value === 'custom') {
                    customInput.style.display = 'block';
                    customInput.focus();
                } else {
                    customInput.style.display = 'none';
                }
            });
        }

        function loadTimelines() {
            const stored = localStorage.getItem('event_timeline_v1');
            if (stored) {
                const data = JSON.parse(stored);
                const select = document.getElementById('timelineSelect');

                if (data.eventInfo?.startTime) {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(data.eventInfo);
                    option.textContent = `Event: ${data.eventInfo.date || ''} at ${data.eventInfo.startTime}`;
                    select.appendChild(option);
                }
            }
        }

        function syncWithTimeline() {
            const select = document.getElementById('timelineSelect');
            if (!select.value) {
                eventStartTime = null;
                eventDuration = null;
                document.getElementById('syncStatus').textContent = '';
                render();
                return;
            }

            const info = JSON.parse(select.value);
            eventStartTime = info.startTime;

            // Calculate total duration from timeline items
            const timeline = JSON.parse(localStorage.getItem('event_timeline_v1'));
            if (timeline?.items) {
                eventDuration = timeline.items.reduce((sum, item) => sum + item.duration + item.buffer, 0);
            }

            document.getElementById('syncStatus').textContent =
                `Synced: Start ${eventStartTime}, Duration ${Math.floor(eventDuration / 60)}h ${eventDuration % 60}m`;
            render();
        }

        function addSong() {
            const title = document.getElementById('songTitle').value.trim();
            const artist = document.getElementById('songArtist').value.trim();
            const genre = document.getElementById('songGenre').value;

            let duration = document.getElementById('songDuration').value;
            if (duration === 'custom') {
                duration = parseInt(document.getElementById('customDuration').value) || 240;
            } else {
                duration = parseInt(duration);
            }

            if (!title) {
                alert('Please enter a song title');
                return;
            }

            songs.push({
                id: Date.now(),
                title,
                artist,
                duration,
                genre,
                notes: ''
            });

            savePlaylist();
            render();
            clearForm();
        }

        function addPreset(type) {
            const preset = PRESETS[type];
            if (preset) {
                preset.forEach((song, i) => {
                    setTimeout(() => {
                        songs.push({
                            id: Date.now() + i,
                            ...song
                        });
                        savePlaylist();
                        render();
                    }, i * 10);
                });
            }
        }

        function clearForm() {
            document.getElementById('songTitle').value = '';
            document.getElementById('songArtist').value = '';
            document.getElementById('songDuration').value = '240';
            document.getElementById('customDuration').value = '';
            document.getElementById('customDuration').style.display = 'none';
        }

        function deleteSong(id) {
            songs = songs.filter(s => s.id !== id);
            savePlaylist();
            render();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatClockTime(date) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function render() {
            const list = document.getElementById('songList');
            let currentTime = eventStartTime ? new Date(`2000-01-01T${eventStartTime}`) : null;

            let totalSeconds = 0;

            list.innerHTML = songs.map((song, index) => {
                totalSeconds += song.duration;

                let timeDisplay = '';
                if (currentTime) {
                    const startStr = formatClockTime(currentTime);
                    currentTime = new Date(currentTime.getTime() + song.duration * 1000);
                    const endStr = formatClockTime(currentTime);
                    timeDisplay = `<span class="time-slot">${startStr}</span>`;
                }

                // Check for segment transitions (every 45 mins)
                const isSegmentStart = index > 0 && (totalSeconds - song.duration) % 2700 < song.duration; // Rough 45 min blocks

                return `
                ${isSegmentStart ? '<div class="segment-divider"><span>~ 45 Minute Mark ~</span></div>' : ''}
                <div class="song-item" draggable="true" data-id="${song.id}" data-index="${index}">
                    <div class="drag-handle">::</div>
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist || 'Unknown Artist'}</div>
                        <span class="song-genre">${song.genre}</span>
                    </div>
                    <span class="duration-badge">${formatTime(song.duration)}</span>
                    ${timeDisplay}
                    <button class="btn btn-danger" onclick="deleteSong(${song.id})">×</button>
                </div>
                `;
            }).join('');

            // Update stats
            document.getElementById('totalSongs').textContent = songs.length;
            document.getElementById('totalDuration').textContent = formatTime(totalSeconds);
            document.getElementById('avgDuration').textContent =
                songs.length ? formatTime(Math.round(totalSeconds / songs.length)) : '00:00';

            // Calculate end time
            if (eventStartTime && currentTime) {
                document.getElementById('endTime').textContent = formatClockTime(currentTime);

                // Check for overage
                if (eventDuration && totalSeconds > eventDuration * 60) {
                    const overage = totalSeconds - (eventDuration * 60);
                    document.getElementById('overageWarning').classList.add('active');
                    document.getElementById('overageAmount').textContent = formatTime(overage);
                } else {
                    document.getElementById('overageWarning').classList.remove('active');
                }
            } else {
                document.getElementById('endTime').textContent = '--:--';
            }

            // Setup drag and drop
            setupDragDrop();
        }

        function setupDragDrop() {
            const items = document.querySelectorAll('.song-item');
            let draggedItem = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (item === draggedItem) return;

                    const rect = item.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;

                    if (e.clientY < midY) {
                        item.parentNode.insertBefore(draggedItem, item);
                    } else {
                        item.parentNode.insertBefore(draggedItem, item.nextSibling);
                    }
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    // Update songs array based on new order
                    const newOrder = Array.from(document.querySelectorAll('.song-item')).map(el =>
                        parseInt(el.dataset.id)
                    );
                    // Filter simply to reorder. If ID missing, skip
                    const reordered = [];
                    newOrder.forEach(id => {
                        const s = songs.find(x => x.id === id);
                        if (s) reordered.push(s);
                    });
                    songs = reordered;

                    savePlaylist();
                    render();
                });
            });
        }

        function savePlaylist() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(songs));
        }

        function loadPlaylist() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                songs = JSON.parse(stored);
                render();
            }
        }

        function exportPlaylist() {
            const exportData = {
                app: "WhisperWorkshop",
                type: "playlistTimer",
                version: "1.0",
                timestamp: new Date().toISOString(),
                data: songs // Using direct array or object depending on standardization
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `playlist_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importPlaylist(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    let data;

                    if (json.app === "WhisperWorkshop" && json.type === "playlistTimer") {
                        data = json.data;
                    } else {
                        data = json;
                    }

                    // Handle if data is array or object
                    const newSongs = Array.isArray(data) ? data : (data.playlist || []);

                    if (newSongs.length > 0 && confirm(`Import ${newSongs.length} songs?`)) {
                        songs = [...songs, ...newSongs];
                        savePlaylist();
                        render();
                    }
                } catch (err) {
                    alert('Invalid playlist file');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function clearPlaylist() {
            if (!confirm('Clear entire playlist?')) return;
            songs = [];
            savePlaylist();
            render();
        }

        function shareWithDJ() {
            const playlistText = songs.map((s, i) =>
                `${i + 1}. ${s.title} - ${s.artist} (${formatTime(s.duration)}) [${s.genre}]`
            ).join('\n');

            const totalDuration = formatTime(songs.reduce((sum, s) => sum + s.duration, 0));

            const emailBody = `Hi DJ,%0D%0A%0D%0AHere's the playlist for the event:%0D%0A%0D%0A${encodeURIComponent(playlistText)}%0D%0A%0D%0ATotal: ${songs.length} songs, ${totalDuration} runtime%0D%0A%0D%0APlease let me know if you have any questions!%0D%0A%0D%0AThanks!`;

            window.location.href = `mailto:?subject=Event Playlist (${songs.length} songs)&body=${emailBody}`;
        }
    </script>
</body>

</html>